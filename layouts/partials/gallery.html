<section class="gallery">
  <div id="gallery">
    {{ $images := slice }}
    {{ range $image := .Resources.ByType "image" }}
      {{ $title := "" }}
      {{ $date := "" }}
      {{ $aperture := "" }}
      {{ $shutterSpeed := "" }}
      {{ $iso := "" }}
      {{ $focalLength := "" }}
      {{ $cameraModel := "" }}
      {{ $lensModel := "" }}
      {{ $copyright := "" }}
      {{ $artist := "" }}
      {{ $keywords := "" }}
      {{ with $image.Meta }}
        {{ $date = .Date }}
        {{ with .Exif.ImageDescription }}
          {{/* Title from EXIF ImageDescription */}}
          {{ $title = . }}
        {{ end }}
        {{/* Copyright info */}}
        {{ with .Exif.Copyright }}
          {{ $copyright = . }}
        {{ end }}
        {{/* Artist info */}}
        {{ with .Exif.Artist }}
          {{ $artist = . }}
        {{ end }}
        {{/* Keywords/Tags - try multiple possible EXIF fields */}}
        {{ with .Exif.subject }}
          {{ $keywords = . }}
        {{ end }}
        {{ if not $keywords }}
          {{ with .Exif.Subject }}
            {{ $keywords = . }}
          {{ end }}
        {{ end }}
        {{ if not $keywords }}
          {{ with .Exif.Keywords }}
            {{ $keywords = . }}
          {{ end }}
        {{ end }}
        {{ if not $keywords }}
          {{ with .XMP.Subject }}
            {{ $keywords = delimit . ", " }}
          {{ end }}
        {{ end }}
        {{/* Extract photographic EXIF data */}}
        {{ with .Exif.FNumber }}
          {{/* FNumber may be a fraction string like "14/5" or a number */}}
          {{ $fStr := printf "%v" . }}
          {{ if strings.Contains $fStr "/" }}
            {{ $parts := split $fStr "/" }}
            {{ $num := float (index $parts 0) }}
            {{ $den := float (index $parts 1) }}
            {{ $aperture = printf "f/%.1f" (div $num $den) }}
          {{ else }}
            {{ $aperture = printf "f/%.1f" (float .) }}
          {{ end }}
        {{ end }}
        {{ with .Exif.ExposureTime }}
          {{/* ExposureTime may be a fraction string like "1/1600" or a number */}}
          {{ $expStr := printf "%v" . }}
          {{ if strings.Contains $expStr "/" }}
            {{ $shutterSpeed = $expStr }}
          {{ else }}
            {{ $exp := float . }}
            {{ if gt $exp 0 }}
              {{ if lt $exp 1.0 }}
                {{ $shutterSpeed = printf "1/%ds" (int (math.Round (div 1.0 $exp))) }}
              {{ else }}
                {{ $shutterSpeed = printf "%.1fs" $exp }}
              {{ end }}
            {{ end }}
          {{ end }}
        {{ end }}
        {{ with .Exif.ISO }}
          {{ $iso = printf "ISO %v" . }}
        {{ end }}
        {{ with .Exif.FocalLength }}
          {{ $focalLength = printf "%vmm" . }}
        {{ end }}
        {{ with .Exif.Model }}
          {{ $cameraModel = . }}
        {{ end }}
        {{ with .Exif.LensModel }}
          {{ $lensModel = . }}
        {{ end }}
      {{ end }}
      {{ if ne $image.Title $image.Name }}
        {{/* Title from front matter */}}
        {{ $title = $image.Title }}
      {{ end }}
      {{ $images = $images | append (dict
        "Name" $image.Name
        "Title" $title
        "Date" $date
        "Aperture" $aperture
        "ShutterSpeed" $shutterSpeed
        "ISO" $iso
        "FocalLength" $focalLength
        "CameraModel" $cameraModel
        "LensModel" $lensModel
        "Copyright" $copyright
        "Artist" $artist
        "Keywords" $keywords
        "image" $image
        )
      }}
    {{ end }}
    {{ range sort $images (.Params.sort_by | default "Name") (.Params.sort_order | default "asc") }}
      {{ $image := .image }}
      {{ $thumbnail := $image.Filter (slice images.AutoOrient (images.Process "fit 600x600")) }}
      {{ $full := $image.Filter (slice images.AutoOrient (images.Process "fit 4000x4000")) }}
      {{ $color := index $thumbnail.Colors 0 | default "transparent" }}
      {{ $ratio := div (mul $thumbnail.Width 1.0) $thumbnail.Height }}
      <a class="gallery-item" href="{{ $image.RelPermalink }}" data-id="{{ $image.RelPermalink | hash.FNV32a }}" data-image-name="{{ $image.Name }}" data-pswp-src="{{ $full.RelPermalink }}" data-pswp-width="{{ $full.Width }}" data-pswp-height="{{ $full.Height }}" title="{{ .Title }}" itemscope itemtype="https://schema.org/ImageObject" style="flex-grow: {{ printf "%.4f" $ratio }}; --ratio: {{ printf "%.4f" $ratio }}">
        <figure style="background-color: {{ $color }}">
          <img loading="lazy" width="{{ $thumbnail.Width }}" height="{{ $thumbnail.Height }}" src="{{ $thumbnail.RelPermalink }}" alt="{{ .Title }}" />
        </figure>
        <div class="like-count" aria-label="Likes"></div>
        <span class="pswp-caption-content">
          {{ with .Title }}<span class="caption-title">{{ . }}</span>{{ end }}
          {{ if or .Aperture .ShutterSpeed .ISO .FocalLength }}
          <span class="caption-exif">
            {{ with .FocalLength }}<span class="exif-item">{{ . }}</span>{{ end }}
            {{ with .Aperture }}<span class="exif-item">{{ . }}</span>{{ end }}
            {{ with .ShutterSpeed }}<span class="exif-item">{{ . }}</span>{{ end }}
            {{ with .ISO }}<span class="exif-item">{{ . }}</span>{{ end }}
          </span>
          {{ end }}
          {{ if or .CameraModel .LensModel }}
          <span class="caption-gear">
            {{ with .CameraModel }}<span class="gear-item">{{ . }}</span>{{ end }}
            {{ with .LensModel }}<span class="gear-item">{{ . }}</span>{{ end }}
          </span>
          {{ end }}
          {{ with .Copyright }}<span class="caption-copyright">{{ . }}</span>{{ end }}
          {{ with .Artist }}<span class="caption-artist">{{ . }}</span>{{ end }}
          {{ with .Keywords }}<span class="caption-keywords">{{ . }}</span>{{ end }}
        </span>
        <meta itemprop="contentUrl" content="{{ $image.RelPermalink }}" />
        {{ with site.Params.Author }}
          <span itemprop="creator" itemtype="https://schema.org/Person" itemscope>
            <meta itemprop="name" content="{{ site.Params.Author.Name }}" />
          </span>
        {{ end }}
      </a>
    {{ end }}
  </div>
</section>